{% extends 'basic.html'%}

{% block head %}
    <script src="static/css/jquery-3.5.1.min.js"></script>
    <script src="static/css/echarts.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
      }
    @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

</style>
    <script type="text/javascript">
          {#CRSF#}
          {##################################}
        var csrftoken = "{{ csrf_token() }}"
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken)
                }
            }
        })
      $(document).ready(function() {
                var currentpage=1;
                var box_xy ;
                var types;
                var features;
                var ID;
                var currentselected=-1;
                var oldcurrentselected=-1;
                var highx=0;
                var highy=0;
                var filedirname;
                var contour;
           $(".pagination li").on('click',function (e) {
              e.preventDefault();



                    if(currentpage<=3){
                        $("#page-"+currentpage+"").removeClass('active');
                    }
                    else{
                         $("#page-3").removeClass('active');
                    }
                    if($(this).text()=="Previous")
                    {
                         if(currentpage==1)
                         {
                             alert("Already first page")
                             return false
                         }
                         else
                             {
                             currentpage-=1
                         }
                    }
                    else if($(this).text()=="Next")
                    {
                        if(currentpage>1000)
                         {
                             alert("Out Of List")
                             return false
                         }
                         else
                             {
                             currentpage+=1
                         }
                    }
                    else
                    {
                        currentpage=parseInt($(this).text())

                    }
                    if(currentpage<=3)
                     {
                         document.getElementById("page-1").innerHTML="<a class=\"page-link\" href=\"#\">1"
                         document.getElementById("page-2").innerHTML="<a class=\"page-link\" href=\"#\">2"
                         document.getElementById("page-3").innerHTML="<a class=\"page-link\" href=\"#\">3"
                         document.getElementById("page-4").innerHTML="<a class=\"page-link\" href=\"#\">4"
                         document.getElementById("page-5").innerHTML="<a class=\"page-link\" href=\"#\">5"

                         $("#page-"+currentpage+"").addClass('active');
                     }
                     else
                     {
                         document.getElementById("page-1").innerHTML="<a class=\"page-link\" href=\"#\">"+(parseInt(currentpage)-2)+""
                         document.getElementById("page-2").innerHTML="<a class=\"page-link\" href=\"#\">"+(parseInt(currentpage)-1)+""
                         document.getElementById("page-3").innerHTML="<a class=\"page-link\" href=\"#\">"+parseInt(currentpage)+""
                         document.getElementById("page-4").innerHTML="<a class=\"page-link\" href=\"#\">"+(parseInt(currentpage)+1)+""
                         document.getElementById("page-5").innerHTML="<a class=\"page-link\" href=\"#\">"+(parseInt(currentpage)+2)+""
                         $("#page-3").addClass('active');
                     }
          });



           var data = {
                        data: JSON.stringify({
                            'currentpage': currentpage,
                        }),
                    }


           $.ajax({
                        type: "POST",
                        dataType: "json",
                        url: "/Braincells_getbox_xy",//后端请求
                        data: data,
                          success: function (result) {
                            contour = result.contour;
                           filedirname=result.filedirname
                    document.getElementById("img1").src="./static/type/images/"+filedirname+".png";
                 box_xy = result.box_xy;
                 for(var i = 0; i < box_xy.length; i++)
                 {
                     for(var j = 0; j < box_xy[i].length; j++)
                     {box_xy[i][j]=box_xy[i][j]*7/10}
                 }
                 types= result.results;
                 ID=result.ID;
                 var ctx2 = document.getElementById("Canvas");
                 var ctx3=ctx2.getContext("2d");
                 ctx3.clearRect(0, 0, cvs.width, cvs.height);

                  //###########################################
                 var imgData = ctx3.createImageData(cvs.width,cvs.height);

                 for(var i = 0; i < contour.length; i++){
                      for(var j = 0; j < contour[i].length; j++){
                           var off = (contour[i][j][1]*7/10 * cvs.width + contour[i][j][0]*7/10) * 4;
                           imgData.data[off  + 0] = 255;
                           imgData.data[off  + 1] = 0;
                           imgData.data[off   + 2] = 0;
                           imgData.data[off  + 3] = 255;

                      }

                 }
                 ctx3.putImageData(imgData, 0, 0);
                 //###########################################

                 for(var i = 0; i < box_xy.length; i++)
                 {
                     ctx3.beginPath();
                     ctx3.rect( box_xy[i][0],box_xy[i][1] , box_xy[i][2],box_xy[i][3])
                     ctx3.lineWidth = 1;
                     ctx3.strokeStyle = "White";
                     ctx3.stroke();
                 }


                var MyScatter = echarts.init(document.getElementById('Scatter'));
                 features=result.features
                var data = features;
                var textStyle = {
                    color: '#333',
                    fontStyle: 'normal',
                    fontWeight: 'normal',
                    fontFamily: '微软雅黑',
                    fontSize: 14,
                };
                option = {
                    tooltip: {
                        /*返回需要的信息*/
                        formatter: function (param) {
                            var value = param.value;
                            return '<div style="border-bottom: 1px solid rgba(255,255,255,.3); font-size: 16px;padding-bottom: 7px;margin-bottom: 7px;"> ' + value[0] + '  ' + value[1]  +
                                '</div>';
                        }
                    },
                    xAxis: {
                        type: 'value',
                        name: "X",
                    },
                    yAxis: {
                        type: 'value',
                        name: "Y",
                    },
                    series: [{
                        name: '',
                        data: data,
                        type: 'scatter',
                        symbolSize:function (params) {
                                    var first=20
                                    var second=5
                            if(highx==params[0]){
                                                        return first;
                                                    }else {
                                                        return second;
                                                    }
                                },
                        itemStyle: {
                                 normal: {
                                    label:{show:false},
                                    color: function (params){
                                       //通过判断选中的名字改变柱子的颜色样式
                                        if(highx==params.value[0]){
                                            return '#261154';
                                        }else {
                                            return '#ffc0cb';
                                        }

                            }
                          },
                    }}]
                };
                MyScatter.setOption(option);
                MyScatter.on('click', function (params) {
                    var value = params.value;
                    highx =value[0]
                    highy =value[1]
                    MyScatter.setOption(option);
                    {#alert(highx+" "+highy)#}
                    for(var k = 0; k < features.length; k++)
                       {
                            {#alert(features[k][0]+" "+features[k][1])#}
                              if(features[k][0]==highx && features[k][1]==highy)
                                  {
                                      currentselected=k
                                    document.getElementById("celltype").innerHTML="Class is "+types[k];
                                      document.getElementById("cell-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/cell-example.png";
                                      document.getElementById("cytoplasm-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/cytoplasm-example.png";
                                      document.getElementById("membrane-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/membrane-example.png";
                                      document.getElementById("nucleus-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/nucleus-example.png";
                                      document.getElementById("processes-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/processes-example.png";
                                      break;
                                  }
                       }
                     var ctx2 = document.getElementById("Canvas");
                     var ctx3=ctx2.getContext("2d");

                  if(oldcurrentselected!=-1)
                  {
                         ctx3.clearRect(box_xy[oldcurrentselected][0]-4, box_xy[oldcurrentselected][1]-4, box_xy[oldcurrentselected][2]+8, box_xy[oldcurrentselected][3]+8);
                         ctx3.beginPath();
                         ctx3.rect(box_xy[oldcurrentselected][0], box_xy[oldcurrentselected][1],box_xy[oldcurrentselected][2], box_xy[oldcurrentselected][3])
                         ctx3.lineWidth = 1;
                         ctx3.strokeStyle = "White";
                         ctx3.stroke();
                  }
                     ctx3.clearRect(box_xy[currentselected][0]-1, box_xy[currentselected][1]-1, box_xy[currentselected][2]+2, box_xy[currentselected][3]+2);
                     ctx3.beginPath();
                     ctx3.rect( box_xy[currentselected][0],box_xy[currentselected][1] , box_xy[currentselected][2],box_xy[currentselected][3])
                     ctx3.lineWidth = 4;
                     ctx3.strokeStyle = "#FF0000";
                     ctx3.stroke();
                     oldcurrentselected=currentselected}
                    )
{#                      $("#btn1").click(function(){#}
{#                            highx= $('#b').val();#}
{#                                        highx1=parseFloat(highx)+0.01#}
{#                                        alert(highx1)#}
{#                            MyScatter.setOption(option);#}
{#                        });#}
             }
                    });



           $.ajax({
             type: "GET",
             dataType: "json",
             url: "/Braincells_getbox_xy",//后端请求
             data: "",
             success: function (result) {
                 filedirname=result.filedirname
                    document.getElementById("img1").src="./static/type/images/"+filedirname+".png";
                 box_xy = result.box_xy;
                 for(var i = 0; i < box_xy.length; i++)
                 {
                     for(var j = 0; j < box_xy[i].length; j++)
                     {box_xy[i][j]=box_xy[i][j]*7/10}
                 }
                 // receive contour from back end
                 contour = result.contour;
                 types= result.results;
                 ID=result.ID;
                 var ctx2 = document.getElementById("Canvas");
                 var ctx3=ctx2.getContext("2d");
                 ctx3.clearRect(0, 0, cvs.width, cvs.height);
                 //###########################################
                 var imgData = ctx3.createImageData(cvs.width,cvs.height);

                 for(var i = 0; i < contour.length; i++){
                      for(var j = 0; j < contour[i].length; j++){
                           var off = (contour[i][j][1]*7/10 * cvs.width + contour[i][j][0]*7/10) * 4;
                           imgData.data[off  + 0] = 255;
                           imgData.data[off  + 1] = 0;
                           imgData.data[off   + 2] = 0;
                           imgData.data[off  + 3] = 255;

                      }

                 }
                 ctx3.putImageData(imgData, 0, 0);
                 //###########################################
                 for(var i = 0; i < box_xy.length; i++)
                 {
                     ctx3.beginPath();
                     ctx3.rect( box_xy[i][0],box_xy[i][1] , box_xy[i][2],box_xy[i][3])
                     ctx3.lineWidth = 1;
                     ctx3.strokeStyle = "White";
                     ctx3.stroke();
                 }
                var MyScatter = echarts.init(document.getElementById('Scatter'));
                 features=result.features
                var data = features;
                var textStyle = {
                    color: '#333',
                    fontStyle: 'normal',
                    fontWeight: 'normal',
                    fontFamily: '微软雅黑',
                    fontSize: 14,
                };
                option = {
                    tooltip: {
                        /*返回需要的信息*/
                        formatter: function (param) {
                            var value = param.value;
                            return '<div style="border-bottom: 1px solid rgba(255,255,255,.3); font-size: 16px;padding-bottom: 7px;margin-bottom: 7px;"> ' + value[0] + '  ' + value[1]  +
                                '</div>';
                        }
                    },
                    xAxis: {
                        type: 'value',
                        name: "X",
                    },
                    yAxis: {
                        type: 'value',
                        name: "Y",
                    },
                    series: [{
                        name: '',
                        data: data,
                        type: 'scatter',
                        symbolSize:function (params) {
                                    var first=20
                                    var second=5
                            if(highx==params[0]){
                                                        return first;
                                                    }else {
                                                        return second;
                                                    }
                                },
                        itemStyle: {
                                 normal: {
                                    label:{show:false},
                                    color: function (params){
                                       //通过判断选中的名字改变柱子的颜色样式
                                        if(highx==params.value[0]){
                                            return '#261154';
                                        }else {
                                            return '#ffc0cb';
                                        }

                            }
                          },
                    }}]
                };
                MyScatter.setOption(option);
                MyScatter.on('click', function (params) {
                    var value = params.value;
                    highx =value[0]
                    highy =value[1]
                    MyScatter.setOption(option);
                    {#alert(highx+" "+highy)#}
                    for(var k = 0; k < features.length; k++)
                       {
                            {#alert(features[k][0]+" "+features[k][1])#}
                              if(features[k][0]==highx && features[k][1]==highy)
                                  {
                                      currentselected=k
                                    document.getElementById("celltype").innerHTML="Class is "+types[k];
                                      document.getElementById("cell-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/cell-example.png";
                                      document.getElementById("cytoplasm-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/cytoplasm-example.png";
                                      document.getElementById("membrane-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/membrane-example.png";
                                      document.getElementById("nucleus-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/nucleus-example.png";
                                      document.getElementById("processes-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/processes-example.png";
                                      break;
                                  }
                       }
                     var ctx2 = document.getElementById("Canvas");
                     var ctx3=ctx2.getContext("2d");
                  if(oldcurrentselected!=-1){
                         ctx3.clearRect(box_xy[oldcurrentselected][0]-4, box_xy[oldcurrentselected][1]-4, box_xy[oldcurrentselected][2]+8, box_xy[oldcurrentselected][3]+8);
                     ctx3.beginPath();
                     ctx3.rect(box_xy[oldcurrentselected][0], box_xy[oldcurrentselected][1],box_xy[oldcurrentselected][2], box_xy[oldcurrentselected][3])
                     ctx3.lineWidth = 1;
                     ctx3.strokeStyle = "White";
                     ctx3.stroke();}
                 ctx3.clearRect(box_xy[currentselected][0]-1, box_xy[currentselected][1]-1, box_xy[currentselected][2]+2, box_xy[currentselected][3]+2);
                 ctx3.beginPath();
                 ctx3.rect( box_xy[currentselected][0],box_xy[currentselected][1] , box_xy[currentselected][2],box_xy[currentselected][3])
                 ctx3.lineWidth = 4;
                 ctx3.strokeStyle = "#FF0000";
                 ctx3.stroke();
                     oldcurrentselected=currentselected}
                    )
{#                      $("#btn1").click(function(){#}
{#                            highx= $('#b').val();#}
{#                                        highx1=parseFloat(highx)+0.01#}
{#                                        alert(highx1)#}
{#                            MyScatter.setOption(option);#}
{#                        });#}
             }
         });




           {###detect click on boxes#}
           cvs = document.getElementById("Canvas");
           ctx = cvs.getContext('2d');
           cvs.addEventListener("click", function(e){
                var sign=0
              p = getEventPosition(e);
                     for(var k = 0; k < box_xy.length; k++)
                       {

                              if(parseInt(box_xy[k][0])<=p.x && (parseInt(box_xy[k][0])+parseInt(box_xy[k][2]))>=p.x&&p.y<=(parseInt(box_xy[k][1])+parseInt(box_xy[k][3])) && p.y>=parseInt(box_xy[k][1]))
                                  {
                                      currentselected=k
                                      sign=1
                                    document.getElementById("celltype").innerHTML="Class is "+types[k];
                                      document.getElementById("cell-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/cell-example.png";
                                      document.getElementById("cytoplasm-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/cytoplasm-example.png";
                                      document.getElementById("membrane-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/membrane-example.png";
                                      document.getElementById("nucleus-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/nucleus-example.png";
                                      document.getElementById("processes-example").src="./static/type/segmentation/"+filedirname+"/"+ID[k]+"/processes-example.png";
                                    break
                                  }
                       }
                     if(sign==0){
                         alert("NoneSelected")
                     }
                     else{
                         var ctx2 = document.getElementById("Canvas");
                     var ctx3=ctx2.getContext("2d");
                     if(oldcurrentselected!=-1){
                         ctx3.clearRect(box_xy[oldcurrentselected][0]-4, box_xy[oldcurrentselected][1]-4, box_xy[oldcurrentselected][2]+8, box_xy[oldcurrentselected][3]+8);
                     ctx3.beginPath();
                     ctx3.rect(box_xy[oldcurrentselected][0], box_xy[oldcurrentselected][1],box_xy[oldcurrentselected][2], box_xy[oldcurrentselected][3])
                     ctx3.lineWidth = 1;
                     ctx3.strokeStyle = "White";
                     ctx3.stroke();}
                 ctx3.clearRect(box_xy[currentselected][0]-1, box_xy[currentselected][1]-1, box_xy[currentselected][2]+2, box_xy[currentselected][3]+2);
                 ctx3.beginPath();
                 ctx3.rect( box_xy[currentselected][0],box_xy[currentselected][1] , box_xy[currentselected][2],box_xy[currentselected][3])
                 ctx3.lineWidth = 4;
                 ctx3.strokeStyle = "#FF0000";
                 ctx3.stroke();
                 oldcurrentselected=currentselected
                    highx =features[currentselected][0]
                    highy =features[currentselected][1]
                    var MyScatter = echarts.init(document.getElementById('Scatter'));
                    MyScatter.setOption(option);
               }
              //判断点击了那个圆
            }, false);
            //注：使用这个函数，需要给Canvas元素的position设为absolute。
            //要判断事件对象发生的位置，事件对象e的layerX和layerY属性表示Canvas内部坐标系中的坐标
           function getEventPosition(ev){
              var x, y;
              x = ev.offsetX;
              y = ev.offsetY;
              return {x: x, y: y};}

           })
 </script>
{% endblock %}
{% block body %}
    <div class="container-fluid">
    <div class="row h-15">
    <div class="col-12">
    <header>
  <!-- Fixed navbar -->
  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <a class="navbar-brand" href="#">Nav</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Link</a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" href="#">Disabled</a>
        </li>
             <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dropdown</a>
        <div class="dropdown-menu" aria-labelledby="dropdown01">
          <a class="dropdown-item" href="#">Action</a>
          <a class="dropdown-item" href="#">Another action</a>
          <a class="dropdown-item" href="#">Something else here</a>
        </div>
      </li>
      </ul>
      <form class="form-inline mt-2 mt-md-0">
        <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
      </form>
    </div>
  </nav>
</header>
    </div>
    </div>
    </div>
    <div class="container-fluid">
    <div class="row m-0">
    <div class="col-6 ">
            <img id="img1" style="height: 700px;width: 700px;position: absolute;top: 90px;left: 30px " src="./static/type/images/0-13000.png" />
            <canvas width="700" height="700"style="position: absolute;top: 90px;left: 30px;" id="Canvas"></canvas>
            <ul class="pagination pagination-sm" style="left: 200px;top: 800px;position: absolute;">
                <li class="page-item" id="page-Previous" ><a class="page-link" href="#">Previous</a></li>
                <li class="page-item active" id="page-1"><a class="page-link" href="#">1</a></li>
                <li class="page-item" id="page-2"><a class="page-link" href="#">2</a></li>
                <li class="page-item" id="page-3"><a class="page-link" href="#">3</a></li>
                <li class="page-item" id="page-4"><a class="page-link" href="#">4</a></li>
                <li class="page-item" id="page-5"><a class="page-link" href="#">5</a></li>
                <li class="page-item" id="page-Next"><a class="page-link" href="#">Next</a></li>
            </ul>
    </div>
    <div class="col-6 ">
        <div style="height: 500px;width:700px; top: 80px;margin-right: 0px" id="Scatter"></div>
        <div style="height: 250px;width: 700px; top: 500px;" id="Types">
            <br>
             <br>
        <p3  id="celltype">
          &emsp;    &emsp;  &emsp;  &emsp;  &emsp;  &emsp;  &emsp;  &emsp;  &emsp;     Class is None
        </p3>
            <br>
            <br>
            <div class="row">
                <div class="col"> Cell<img style="position: relative;width: 100px;height: 100px" id="cell-example" src="./static/type/segmentation/5000-5000/185363/cell-example.png" /></div>
                <div class="col">cytoplasm<img style="position: relative;width: 100px;height: 100px"id="cytoplasm-example" src="./static/type/segmentation/5000-5000/185363/cytoplasm-example.png" /></div>
                <div class="col">membrane <img style="position: relative;width: 100px;height: 100px"id="membrane-example" src="./static/type/segmentation/5000-5000/185363/membrane-example.png" /></div>
                <div class="col">nucleus<img style="position: relative;width: 100px;height: 100px"id="nucleus-example" src="./static/type/segmentation/5000-5000/185363/nucleus-example.png" /></div>
                <div class="col">processes <img style="position: relative;width: 100px;height: 100px"id="processes-example" src="./static/type/segmentation/5000-5000/185363/processes-example.png" /></div>
            </div>
        </div>


    </div>
    </div>
     </div>
{% endblock %}
